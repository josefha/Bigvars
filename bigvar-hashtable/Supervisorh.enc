

module Supervisorh

import Siphash
import Workerh


trait GererateHash
  def modulo(value : uint, mod : uint) : uint
    EMBED (uint)
      uint64_t value = (uint64_t) #{value};
            uint64_t mod   = (uint64_t) #{mod};
            (value % mod);
    END
  end
end


local class Supervisor[k,v]
    var numOfWorkers: int
    var workers : [(Worker[k,v])]
    var tableSize : int
    var idCounter : int
    var siphash: Siphash

    def init() : unit
        this.siphash = new Siphash()
        this.numOfWorkers = 4
        this.workers = new[Worker[k,v]](this.numOfWorkers)
        this.tableSize = 128*this.numOfWorkers
        this.idCounter = 0
        this.initTable()
    end

    def initTable() : unit
        repeat i <- this.numOfWorkers do
            this.workers(i) = new Worker[k,v](129,i)
        end
    end

    def generateHash(key:k) : uint
        val pointer = EMBED (uint) (uint64_t) #{key}.p; END
        val hash = this.siphash.hash(pointer)
        hash
    end

    def put(key:k,value:v) : Fut[unit]
        var hash = this.generateHash(key)
        var workerID = hash % this.numOfWorkers
        this.workers(workerID) ! put(key,value,hash)
    end

    def get(key:k) : v
        var hash = this.generateHash(key)
        var workerID = hash % this.numOfWorkers
        var value = get(this.workers(workerID) ! get(key,hash))
        value
    end

end
